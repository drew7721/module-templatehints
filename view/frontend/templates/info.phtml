<?php
/**
 * Copyright Â© 2020
 * @copyright Alex Ghiban & JustinKase.ca - All rights reserved.
 * @license GPL-3.0-only
 * @see https://justinkase.ca
 * @see https://ghiban.com
 * @see https://alexghiban.me
 * @contact <alex@justinkase.ca>
 */

/**
 * Additional information template.
 *
 * @author Alex Ghiban <drew7721@gmail.com>
 *
 * @var \JustinKase\LayoutHints\Block\Info $block
 */
?>
<?php if ($block->isDeveloperMode()): ?>
    <?php if ($block->hintsAreEnabled()): ?>
            <div class="justinkase-hint-footer">
                <h4>Page Information</h4>
                <ul>
                    <li><b>Cache Id:</b> <?= $block->getLayout()->getUpdate()->getCacheId(); ?></li>
                </ul>

                <h4>Used Layout Update Handles</h4>
                <?php foreach($block->getLayout()->getUpdate()->getHandles() as $handle): ?>
                    <ul>
                        <li><code><?= $handle; ?></code></li>
                    </ul>
                <?php endforeach; ?>
                <h4>Available Containers</h4>
                <?php foreach($block->getLayout()->getUpdate()->getContainers() as $containerName => $container): ?>
                    <ul>
                        <li><code><?= $containerName; ?></code> => <b><?= $container ?></b></li>
                    </ul>
                <?php endforeach; ?>
                <h4>Design Abstractions</h4>
                <?php foreach ($block->getLayout()->getUpdate()->getAllDesignAbstractions() as $designAbstraction): ?>
                    <ul>
                        <li><b>Label:</b> <?= $designAbstraction['label']; ?></li>
                        <li><b>Name:</b> <?= $designAbstraction['name']; ?></li>
                        <li><b>Abstraction:</b> <?= $designAbstraction['design_abstraction']; ?></li>
                    </ul>
                <?php endforeach; ?>
                <h4>Page Blocks</h4>
                <?php foreach ($block->getLayout()->getAllBlocks() as $blockName => $block): ?>
                    <div>
                        <h5><?= $blockName; ?></h5>
                        <ul>
                            <li><?= $block->getTemplateFile() ?></li>
                            <li><?= $block->getTemplate() ?></li>
                            <li><?= $block->getCacheKey() ?></li>
                        </ul>
                    </div>
                <?php endforeach; ?>
            </div>
    <?php endif; ?>
<script>
    (function(){
        function notify(message) {
            var options;
            var title;
            if ("Notification" in window) {
                title = "JKase";
                options = {
                    icon: "https://i.imgur.com/Jd1JWSL.png",
                    body: message
                };
                if(Notification.permission !== "granted") {
                    Notification.requestPermission().then(function (permission) {
                        if (permission === "granted") {
                            new Notification(title, options);
                        }
                    });
                } else {
                    new Notification(title, options);
                }
            }
        }

        function sendRequest(action) {
            var endpoint;
            var httpRequest;
            if (window.XMLHttpRequest) {
                httpRequest = new XMLHttpRequest();
                endpoint = window.location.origin + "/<?= $block->getStoreCode(); ?>jkase?action=" + action;
                httpRequest.onreadystatechange = function(){
                    if (httpRequest.readyState === XMLHttpRequest.DONE) {
                        if (httpRequest.status === 200) {
                            notify(JSON.parse(httpRequest.responseText).result);
                        } else {
                            notify('There was a problem with the request.');
                        }
                    }
                };
                httpRequest.open('GET', endpoint);
                httpRequest.send();
            }
        }

        document.addEventListener('keydown', function (e) {
            if (e.shiftKey && e.ctrlKey) {
                if (e.key === 'H') {
                    document.getElementsByTagName('body')[0].classList.toggle('justinkase-hints-enabled');
                }
                if (e.key === 'C') {
                    notify("Clearing caches...");
                    sendRequest('clearCaches')
                }

                if (e.key === '_') {
                    notify("Turning Hints Off from backend...");
                    sendRequest('hintsOff')
                }

                if (e.key === '+') {
                    notify("Turning Hints ON from backend...");
                    sendRequest('hintsOn')
                }
            }
        })
    }());
</script>
<?php endif; ?>
